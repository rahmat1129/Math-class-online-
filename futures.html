<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Website Builder (Live Preview + Fullscreen)</title>
    <!-- CSS Links and Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================= */
        /* ====== START: Consolidated & Cleaned CSS ====== */
        /* ============================================= */

        /* Basic Reset */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Prevent scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        .container {
            max-width: 1100px; /* Increased width for side-by-side */
            width: 100%;
            margin: 20px auto;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .dark-mode .container {
            background: #1e1e1e;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.05);
        }

        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
            position: relative; /* For positioning toggle button */
        }

         .dark-mode .header {
             border-bottom-color: #333;
         }

        .header h1 {
            margin: 0 0 5px 0;
            color: #343a40;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        .dark-mode .header h1 {
            color: #ffffff;
        }

        .header p {
            color: #6c757d;
            margin-bottom: 15px;
            transition: color 0.3s ease;
        }
        .dark-mode .header p{
             color: #9aa0a6;
        }

        /* --- Input & Controls --- */
        .input-container, .modify-container, .upload-container, .github-upload-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }
         .input-group {
             display: flex;
             align-items: center;
             gap:10px;
             margin-bottom: 10px;
          }
         .input-group label{
             min-width: 80px;
             text-align: right;
             flex-shrink: 0;
         }

        input[type="text"], textarea, input[type="file"], select {
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 16px;
            width: 100%;
            background-color: #fff;
            color: #333;
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.3s ease;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .dark-mode input[type="text"],
        .dark-mode textarea,
        .dark-mode input[type="file"],
        .dark-mode select {
             background-color: #2a2a2a;
             color:#e0e0e0;
             border-color:#444;
        }

         /* File Input Style */
        input[type="file"] { padding: 5px; }
        input[type="file"]::-webkit-file-upload-button { visibility: hidden; }
        input[type="file"]::before {
          content: 'Select File'; display: inline-block; background: #007bff; color: white;
          border: none; border-radius: 3px; padding: 8px 12px; outline: none;
          white-space: nowrap; cursor: pointer; font-weight: 500; font-size: 14px;
          margin-right: 10px; transition: background-color .3s;
        }
         input[type="file"]:hover:not(:disabled)::before { background-color: #0056b3; }
         input[type="file"]:disabled::before { background-color: #cccccc; cursor: not-allowed; opacity: 0.7; }
         .dark-mode input[type="file"]::before { background: #0056b3; }
         .dark-mode input[type="file"]:hover:not(:disabled)::before { background: #004494; }
         .dark-mode input[type="file"]:disabled::before { background: #555; }

        /* Buttons */
        button {
            padding: 12px 18px; background-color: #007bff; color: white;
            border: none; border-radius: 6px; cursor: pointer;
            font-size: 16px; font-weight: 500;
            transition: background-color 0.3s, opacity 0.3s;
        }
        button:hover:not(:disabled) { background-color: #0056b3; }
        button:disabled {
            background-color: #cccccc; color: #666; cursor: not-allowed; opacity: 0.7;
        }
         .dark-mode button:disabled { background-color: #555; color: #aaa; }

        /* --- Tabs --- */
        .tab-buttons { display: flex; margin-bottom: 20px; gap: 5px; flex-wrap: wrap; border-bottom: 1px solid #dee2e6;}
         .dark-mode .tab-buttons { border-bottom-color: #333; }
        .tab-button {
            padding: 12px 18px; background-color: #e9ecef; border: 1px solid #dee2e6;
            border-bottom: none; border-radius: 6px 6px 0 0; cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
            font-weight: 500; color: #495057; white-space: nowrap; margin-bottom: -1px; /* Overlap bottom border */
        }
         .dark-mode .tab-button { background-color:#2a2a2a; border-color:#444; color: #ccc; }
        .tab-button:hover { background-color: #dee2e6; }
         .dark-mode .tab-button:hover { background-color: #3a3a3a; }
        .tab-button.active {
            background-color: #ffffff; border-color: #dee2e6; border-bottom-color: #ffffff;
            color: #007bff; font-weight: bold;
        }
         .dark-mode .tab-button.active {
            background-color: #1e1e1e; border-color: #444; border-bottom-color: #1e1e1e;
            color: #66bfff;
         }

        .tab-content { padding-top: 20px; } /* Removed border, add padding */
         /* No border/bg change needed as it's now part of main container */


        /* --- Code & Preview Area --- */
        .output-section { /* Container for Preview/Code and Toolbar */
            margin-top: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden; /* Important for rounding */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .dark-mode .output-section {
            border-color: #333;
            box-shadow: 0 2px 10px rgba(255,255,255, 0.05);
        }

        /* Toolbar specific */
        .code-toolbar {
            display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 15px;
            background: #f8f9fa; border-bottom: 1px solid #e0e0e0;
            justify-content: flex-start;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border-radius: 8px 8px 0 0; /* Round top of toolbar */
        }
        .dark-mode .code-toolbar{ background: #2a2a2a; border-bottom-color: #333; }

        /* Layout for side-by-side Preview and Code Editor */
        .preview-code-wrapper {
            display: flex;
            flex-wrap: wrap; /* Allow stacking on smaller screens */
            min-height: 450px; /* Set a minimum height */
            background-color: #f8f9fa; /* Match code bg */
        }
        .dark-mode .preview-code-wrapper { background-color: #2d2d2d; } /* Match dark code bg */


        .preview-pane, .code-pane {
            flex: 1 1 50%; /* Each takes half width, allow shrinking/growing */
            position: relative; /* Needed for absolute positioning inside */
            display: flex; /* Make them flex containers */
            flex-direction: column; /* Stack elements vertically */
            overflow: hidden; /* Hide overflow */
            min-width: 300px; /* Prevent extreme shrinking */
        }
        /* Add border between panes */
        .preview-pane { border-right: 1px solid #e0e0e0; }
        .dark-mode .preview-pane { border-right-color: #333; }

        /* Styling the Inline Preview */
        .preview-pane h3, .code-pane h3 { /* Titles */
             font-size: 14px;
             padding: 8px 15px;
             margin: 0;
             font-weight: 600;
             background-color: #e9ecef; /* Light title background */
             color: #495057;
             border-bottom: 1px solid #e0e0e0;
             flex-shrink: 0; /* Prevent title from shrinking */
         }
        .dark-mode .preview-pane h3, .dark-mode .code-pane h3 {
            background-color: #2a2a2a;
            border-bottom-color: #333;
             color: #ccc;
         }

        iframe#inlineCodePreview {
            width: 100%;
            flex-grow: 1; /* Takes remaining vertical space */
            border: none;
            margin: 0;
            display: block;
            background-color: #fff; /* White background for preview content */
        }
        /* Dark mode doesn't change iframe bg unless content has dark styles */


        /* Eye Icon for Fullscreen Preview */
        #toggleFullscreenBtn {
            position: absolute;
            top: 5px; /* Adjusted position relative to pane */
            right: 10px;
            z-index: 5;
            background-color: rgba(52, 58, 64, 0.7); /* Semi-transparent */
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px; height: 32px;
            padding: 0;
            font-size: 18px;
            line-height: 32px; /* Center icon vertically */
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
        }
        #toggleFullscreenBtn:hover:not(:disabled) {
            background-color: rgba(52, 58, 64, 0.9);
        }
         #toggleFullscreenBtn:disabled {
             background-color: rgba(108, 117, 125, 0.5);
             cursor: not-allowed; opacity: 0.6;
         }

        /* Styling the Code Display/Editor Area */
        pre[class*="language-"], textarea#editableCode {
            flex-grow: 1; /* Takes remaining vertical space */
            width: 100%;
            margin: 0 !important; padding: 20px !important;
            background-color: #f8f9fa !important; color: #212529 !important;
            overflow: auto; /* Enable scrolling within the code area */
            font-family: 'Courier New', Courier, monospace; font-size: 15px; line-height: 1.5;
            min-height: 200px; border: none; border-radius: 0; /* No rounding needed inside pane */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode pre[class*="language-"], .dark-mode textarea#editableCode {
             background-color: #2d2d2d !important; color: #f8f8f2 !important;
         }
        textarea#editableCode { /* Editing state specific */
            background-color: #ffffff !important; color: #333 !important;
            border: 1px solid #ccc !important; /* Add border when editing */
        }
        .dark-mode textarea#editableCode {
             background-color: #2a2a2a !important; color: #e0e0e0 !important;
             border: 1px solid #444 !important;
         }


        /* Toolbar Buttons */
        .code-btn {
            padding: 8px 14px; border: none; border-radius: 5px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: opacity 0.3s, background-color 0.3s;
            color: white; white-space: nowrap;
        }
        .code-btn:hover:not(:disabled) { opacity: 0.85; }
        /* Specific button colors */
        .copy-btn { background-color: #28a745; }
        .download-btn { background-color: #17a2b8; }
        .clear-btn { background-color: #dc3545; } /* Clear is red (Input Section)*/
        .refresh-btn { background-color: #6c757d; }
        .upload-btn { background-color: #fd7e14; } /* Upload orange */
        .continue-btn { background-color: #6f42c1; } /* Continue purple */
        .toggle-mode-btn { /* Page Theme Toggle */
            background-color: #343a40; position: absolute; top: 15px; right: 15px;
            padding: 8px 12px; z-index: 1000; border: none;
        }
        .dark-mode .toggle-mode-btn { background-color: #555; }
        .edit-btn { background-color: #ffc107; color: #333; } /* Edit yellow */
        .modify-btn { background-color: #ff9800; } /* Modify amber */
        .clear-history-btn { background-color: #6c757d; font-size: 13px; padding: 6px 10px; margin-left: auto;} /* Grey, small */

        /* --- Status & Error Messages --- */
        .status-container, .error-message {
            margin: 15px 0; padding: 10px 15px; border-radius: 6px;
            text-align: center; font-weight: 500;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .status-container { background-color: #e9ecef; }
        .dark-mode .status-container { background-color: #2a2a2a; color: #ccc; }
        .error-message { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; line-height: 1.4; }
        .dark-mode .error-message { background-color: #5c2a2f; color: #f8d7da; border-color: #8c4a54; }


        /* --- History --- */
        .history-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .history-container { margin-top: 25px; border-top: 1px solid #e0e0e0; padding-top: 15px; }
         .dark-mode .history-container { border-top-color: #333; }
         .history-container h3 { margin: 0; font-size: 18px; }
        .history-item {
            padding: 10px 12px; background-color: #f8f9fa; border: 1px solid #dee2e6;
            border-radius: 5px; margin-bottom: 8px; cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .dark-mode .history-item{ background-color:#2a2a2a; border-color:#444; color:#ccc; }
        .history-item:hover {
            background-color: #e9ecef; border-color: #adb5bd;
            white-space: normal; overflow: visible; z-index: 1; position: relative;
        }
        .dark-mode .history-item:hover{ background-color: #3a3a3a; border-color: #555; }

        /* --- Upload Specific --- */
        #uploadLinkContainer {
             margin-top: 15px; padding: 10px; background-color: #e9f7ef;
             border: 1px solid #a7d7c5; border-radius: 6px;
         }
         .dark-mode #uploadLinkContainer { background-color: #2a4a3a; border-color: #4a7a6a; color: #e0e0e0; }
         #uploadLinkContainer p { margin: 0 0 5px 0; line-height: 1.5; }
         #uploadLinkContainer a { color: #007bff; text-decoration: none; font-weight: bold; word-break: break-all; }
         #uploadLinkContainer a:hover { text-decoration: underline; }
         .dark-mode #uploadLinkContainer a { color: #66bfff; }
         .upload-response { margin-top: 15px; font-weight: bold; }
         .dark-mode .upload-response{ color: #e0e0e0; }
         #imagePreviewContainer { margin-top: 15px; text-align:center; }
        #imagePreview {
            max-width: 100%; max-height: 250px; border: 1px solid #dee2e6;
            border-radius: 6px; display: none; object-fit: contain;
        }
        .dark-mode #imagePreview{ border-color:#444; }

        /* --- Previous Code Display --- */
        .previous-code-container {
            margin-top: 20px; border: 1px dashed #ced4da; border-radius: 6px;
            padding: 15px; background-color: #f8f9fa;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .dark-mode .previous-code-container{ background-color: #2a2a2a; border-color: #444; }
        .previous-code-container h3 { margin-bottom: 10px; font-size: 16px; }
        .previous-code-container pre { max-height: 200px; overflow-y: auto; border-radius: 4px; }

        /* --- Model Selection --- */
        .model-selection { margin-bottom: 20px; }
        .model-select-label{ display:block; margin-bottom: 8px; font-weight: 500; }
        .model-selection select {
           -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat; background-position: right 15px center;
            background-size: 20px; padding-right: 40px; cursor: pointer;
         }
         .model-selection select:disabled {
              cursor: not-allowed; opacity: 0.7;
              background-image: url('data:image/svg+xml;utf8,<svg fill="%23cccccc" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
          }
         .dark-mode .model-selection select{
             background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
          }
         .dark-mode .model-selection select:disabled {
               background-image: url('data:image/svg+xml;utf8,<svg fill="%23555555" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
           }

        /* --- Fullscreen Preview Modal --- */
        #fullscreenPreviewModal {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Dark overlay */
            z-index: 1050; /* High z-index */
            padding: 20px;
            box-sizing: border-box;
        }
        #fullscreenPreviewModal.dark-modal { /* Optional: Light overlay in dark mode? */
             /* background-color: rgba(255, 255, 255, 0.85); */
        }
        #fullscreenPreviewIframe {
            width: 100%; height: calc(100% - 50px); /* Adjust height for controls */
            border: 1px solid #555;
            background-color: #fff; /* Always white background */
        }
        .fullscreen-controls {
             position: absolute;
             top: 15px;
             right: 15px;
             display: flex;
             gap: 10px;
        }
        .fullscreen-controls button {
            background-color: rgba(50, 50, 50, 0.8);
            color: white;
            border: 1px solid #aaa;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
         .fullscreen-controls button:hover { background-color: rgba(80, 80, 80, 0.9); }
         #closeFullscreenBtn { font-weight: bold; }


        /* Utility */
        .hidden {
            display: none !important; /* Use important to ensure override */
        }

        /* Responsive Adjustments for Preview/Code Pane */
        @media (max-width: 800px) {
             .preview-code-wrapper { flex-direction: column; } /* Stack panes */
             .preview-pane { border-right: none; border-bottom: 1px solid #e0e0e0; } /* Add bottom border */
             .dark-mode .preview-pane { border-bottom-color: #333; }
             .preview-pane, .code-pane { flex-basis: auto; min-height: 350px; } /* Adjust height */
         }

        /* =========================================== */
        /* ====== END: Consolidated & Cleaned CSS ====== */
        /* =========================================== */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Website Builder</h1>
            <p>Generate, modify, preview, and upload HTML securely</p>
            <button class="code-btn toggle-mode-btn" onclick="toggleMode()" title="Toggle Dark/Light Mode">🌓</button>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" class="error-message hidden" aria-live="assertive"></div>

        <!-- Model Selection -->
        <div class="model-selection">
           <label for="modelSelect" class="model-select-label">Select AI Model:</label>
           <select id="modelSelect" onchange="handleModelChange()" disabled>
               <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 thinking 💭 pro</option>
               <option value="google/gemini-pro">Gemini Pro</option>
               <option value="anthropic/claude-3-haiku-20240307">Claude 3 Haiku (Fast)</option>
               <option value="mistralai/mistral-7b-instruct-v0.2">Mistral 7B Instruct</option>
               <option value="openai/gpt-3.5-turbo">OpenAI GPT-3.5 Turbo</option>
               <option value="anthropic/claude-3-sonnet-20240229">Claude 3 Sonnet</option>
               <option value="google/gemini-1.5-pro-latest">Gemini 1.5 Pro (Advanced)</option>
           </select>
       </div>

       <!-- Tabs -->
       <div class="tab-buttons">
           <button id="generateTabButton" class="tab-button active" onclick="openTab('generate', this)">Generate</button>
           <button id="uploadTabButton" class="tab-button" onclick="openTab('upload', this)">Upload & Modify</button>
       </div>

       <!-- Generate Tab Content-->
       <div id="generateTab" class="tab-content">
            <div class="input-container">
               <textarea id="userPrompt" rows="4" placeholder="Describe the website or component..." aria-label="Website description prompt"></textarea>
               <button id="generateBtn" onclick="generateCode()" disabled>Generate Code</button>
               <button class="code-btn clear-btn" onclick="clearAll()">Clear All Inputs & Output</button>
           </div>
           <div class="modify-container hidden" id="modifyContainer">
               <h2>Modify Generated Code</h2>
               <textarea id="modificationPrompt" rows="4" placeholder="Describe changes..." aria-label="Modification prompt"></textarea>
               <button id="modifyBtn" onclick="modifyCode()" disabled>Apply Modifications</button>
           </div>
       </div>

       <!-- Upload Tab Content -->
       <div id="uploadTab" class="tab-content hidden">
            <div class="upload-container">
               <h2>Upload File for Processing/Modification</h2>
               <p style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">Upload text files or images (AI needed for non-text). Max 10MB.</p>
               <input type="file" id="fileInput" accept=".html,.txt,.js,.css,image/*,application/pdf,.md" onchange="handleFileSelect()" aria-label="File Upload Input">
               <div id="imagePreviewContainer" class="hidden"> <img id="imagePreview" src="" alt="Image Preview"> </div>
               <div id="fileContentContainer" class="previous-code-container hidden">
                   <h3>File Content Preview:</h3> <pre id="fileContent" class="language-markup"></pre>
               </div>
               <div class="upload-response hidden" id="uploadResponse" aria-live="polite"></div>
               <div class="modify-container hidden" id="fileModifyContainer">
                   <h2>Modify Uploaded Content</h2>
                   <textarea id="fileModificationPrompt" rows="4" placeholder="Describe changes..." aria-label="File modification prompt"></textarea>
                   <button id="modifyUploadedBtn" onclick="modifyUploadedCode()" disabled>Apply Changes to Uploaded</button>
               </div>
           </div>
       </div>

        <!-- Status Indicator -->
        <div class="status-container hidden" id="statusContainer" aria-live="polite"> <p id="statusText">Processing...</p> </div>

        <!-- ====== Output Section (Toolbar + Preview/Code) ====== -->
        <div class="output-section hidden" id="outputSection">
           <!-- Code Toolbar -->
           <div class="code-toolbar">
               <button class="code-btn copy-btn" onclick="copyCode()" title="Copy code" disabled>Copy</button>
               <button class="code-btn download-btn" onclick="downloadCode()" title="Download HTML" disabled>Download</button>
               <button id="editBtn" class="code-btn edit-btn" onclick="toggleEditCode()" title="Edit code" disabled>Edit</button>
               <button id="continueBtn" class="code-btn continue-btn hidden" onclick="continueGeneration()" title="Continue generation">Continue Generation</button>
               <button id="modifyAgainBtn" class="code-btn modify-btn" onclick="showModifyForm()" title="Modify again" disabled>Modify Again</button>
               <button id="refreshBtn" class="code-btn refresh-btn" onclick="refreshPreview()" title="Refresh preview" disabled>Refresh Preview</button>
               <button id="showGithubUploadBtn" class="code-btn upload-btn" onclick="showUploadForm()" title="Upload to GitHub" disabled>Upload to GitHub</button>
           </div>

           <!-- Preview and Code Side-by-Side Wrapper -->
           <div class="preview-code-wrapper">
               <!-- Live Preview Pane -->
               <div class="preview-pane">
                    <h3>Live Preview</h3>
                    <button id="toggleFullscreenBtn" class="code-btn" onclick="toggleFullScreenPreview()" title="Toggle Fullscreen Preview" disabled>👁️</button>
                    <iframe id="inlineCodePreview" title="Live Code Preview" aria-label="Inline live preview of the generated code"></iframe>
               </div>

               <!-- Code Display/Editor Pane -->
               <div class="code-pane">
                    <h3 id="codePaneTitle">Generated Code</h3>
                   <pre id="generatedCode" class="language-html" aria-label="Generated code display"></pre>
                   <textarea id="editableCode" class="hidden" spellcheck="false" aria-label="Editable code area"></textarea>
               </div>
           </div>

           <!-- GitHub Upload Link -->
            <div id="uploadLinkContainer" class="hidden" style="padding: 15px; border-top: 1px solid #e0e0e0;">
                 <p>✅ Uploaded Successfully!</p>
                 <p>🔗 Live Link: <a id="uploadedLink" href="#" target="_blank" rel="noopener noreferrer"></a></p>
                 <p><button class="code-btn copy-btn" style="margin-left: 0; margin-top: 5px; padding: 5px 10px; font-size: 12px;" onclick="copyLink()">Copy Live Link</button></p>
                 <p style="font-size: 12px; margin-top: 5px;">(Note: GitHub Pages may take a minute to update)</p>
             </div>

            <!-- Previous Code Display Area -->
             <div class="previous-code-container hidden" id="previousCodeContainer" style="border-radius: 0 0 8px 8px;">
                 <h3>Previous Code (Before Modification/Continuation):</h3>
                 <pre id="previousCode" class="language-html" aria-label="Previous version of the code"></pre>
             </div>
        </div>
        <!-- ====== End Output Section ====== -->

        <!-- GitHub Upload Form -->
       <div class="github-upload-form hidden" id="githubUploadContainer">
           <h2>Upload to GitHub</h2>
           <p style="font-size: 14px; color: #6c757d; margin-bottom: 10px;">Repository: <strong id="ghRepoName">username/repo</strong>. (Ensure repo exists & GH Pages enabled for live link.)</p>
           <input type="text" id="filePath" placeholder="File Path (e.g., index.html)" aria-label="GitHub file path">
           <input type="text" id="commitMessage" placeholder="Commit Message (e.g., 'Add initial website code')" aria-label="GitHub commit message">
           <button id="uploadGithubBtn" onclick="uploadToGitHub()" disabled>Upload File</button>
       </div>

        <!-- History -->
       <div class="history-container">
            <div class="history-section-header">
                <h3>Prompt History</h3>
                <button id="clearHistoryBtn" class="code-btn clear-history-btn" onclick="clearHistory()" title="Clear prompt history" disabled>Clear History</button>
            </div>
           <div id="historyItems" aria-label="List of previous prompts"></div>
       </div>

    </div> <!-- End Container -->

    <!-- Fullscreen Preview Modal -->
    <div id="fullscreenPreviewModal" aria-modal="true" role="dialog" aria-labelledby="fullscreenModalTitle">
        <div class="fullscreen-controls">
             <button id="downloadCodeFullscreenBtn" onclick="downloadCode()" title="Download HTML Code">Download Code</button>
            <button id="closeFullscreenBtn" onclick="closeFullScreenPreview()" title="Close Fullscreen (Esc)">✖ Close</button>
        </div>
         <h2 id="fullscreenModalTitle" class="hidden">Fullscreen Preview</h2> <!-- Hidden title for accessibility -->
        <iframe id="fullscreenPreviewIframe" title="Fullscreen Code Preview"></iframe>
    </div>

    <!-- Prism JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
        // ====== START: Improved JavaScript with Fullscreen ======

        // --- Config Endpoint ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIqI9pIqwucFUC6ojv655AhwEH2b3jsEnwHTZD4Pg7UG5_YGefFdDli_GIBf4xkCOs9g/exec'; // Provided URL

        // --- Fetched Config ---
        let API_KEY = ''; let GITHUB_PAT = ''; let GITHUB_USERNAME = ''; let GITHUB_REPO_NAME = '';

        // --- App State ---
        const SITE_URL = window.location.origin || `${window.location.protocol}//${window.location.hostname}`;
        const SITE_NAME = 'AI Website Builder V3';
        let currentGeneratedHTML = ''; let lastRawOutput = ''; let currentFileContentHTML = '';
        let isEditingCode = false; let history = []; const MAX_HISTORY = 15;
        let selectedModel = ''; let configLoaded = false; let lastPromptForContinuation = '';
        let currentOperationAbortController = null;

        // --- DOM Refs ---
        let userPromptEl, modificationPromptEl, fileModificationPromptEl, generatedCodeEl, editableCodeEl, inlineCodePreviewEl, outputSectionEl, statusContainerEl, statusTextEl, errorDisplayEl, historyItemsEl, previousCodeContainerEl, previousCodeEl, modifyContainerEl, fileInputEl, fileContentContainerEl, fileContentEl, uploadResponseEl, fileModifyContainerEl, imagePreviewContainerEl, imagePreviewEl, githubUploadContainerEl, uploadLinkContainerEl, uploadedLinkEl, filePathEl, commitMessageEl, ghRepoNameEl, modelSelectEl, codePaneTitleEl,
            generateBtn, modifyBtn, modifyUploadedBtn, uploadGithubBtn, showGithubUploadBtn, continueBtn, clearHistoryBtn, copyBtn, downloadBtn, editBtn, modifyAgainBtn, refreshBtn,
            toggleFullscreenBtn, // New Button
            fullscreenPreviewModalEl, fullscreenPreviewIframeEl, closeFullscreenBtn, downloadCodeFullscreenBtn; // New Modal Elements

        // --- Cache DOM ---
        function cacheDOMElements() {
            // Inputs & Containers
            userPromptEl=document.getElementById('userPrompt'); modificationPromptEl=document.getElementById('modificationPrompt'); fileModificationPromptEl=document.getElementById('fileModificationPrompt');
            inlineCodePreviewEl = document.getElementById('inlineCodePreview'); // Changed ID
            generatedCodeEl=document.getElementById('generatedCode'); editableCodeEl=document.getElementById('editableCode'); outputSectionEl=document.getElementById('outputSection');
            statusContainerEl=document.getElementById('statusContainer'); statusTextEl=document.getElementById('statusText'); errorDisplayEl=document.getElementById('errorDisplay');
            historyItemsEl=document.getElementById('historyItems'); previousCodeContainerEl=document.getElementById('previousCodeContainer'); previousCodeEl=document.getElementById('previousCode');
            modifyContainerEl=document.getElementById('modifyContainer'); fileInputEl=document.getElementById('fileInput'); fileContentContainerEl=document.getElementById('fileContentContainer');
            fileContentEl=document.getElementById('fileContent'); uploadResponseEl=document.getElementById('uploadResponse'); fileModifyContainerEl=document.getElementById('fileModifyContainer');
            imagePreviewContainerEl=document.getElementById('imagePreviewContainer'); imagePreviewEl=document.getElementById('imagePreview'); githubUploadContainerEl=document.getElementById('githubUploadContainer');
            uploadLinkContainerEl=document.getElementById('uploadLinkContainer'); uploadedLinkEl=document.getElementById('uploadedLink'); filePathEl=document.getElementById('filePath'); commitMessageEl=document.getElementById('commitMessage');
            ghRepoNameEl=document.getElementById('ghRepoName'); modelSelectEl=document.getElementById('modelSelect'); codePaneTitleEl = document.getElementById('codePaneTitle');

            // Buttons
            generateBtn=document.getElementById('generateBtn'); modifyBtn=document.getElementById('modifyBtn'); modifyUploadedBtn=document.getElementById('modifyUploadedBtn');
            uploadGithubBtn=document.getElementById('uploadGithubBtn'); showGithubUploadBtn=document.getElementById('showGithubUploadBtn'); continueBtn = document.getElementById('continueBtn');
            clearHistoryBtn = document.getElementById('clearHistoryBtn');
            // Toolbar buttons
            copyBtn = outputSectionEl?.querySelector('.copy-btn');
            downloadBtn = outputSectionEl?.querySelector('.download-btn');
            editBtn = document.getElementById('editBtn'); // Used ID
            modifyAgainBtn = document.getElementById('modifyAgainBtn');
            refreshBtn = document.getElementById('refreshBtn'); // Used ID

            // Fullscreen elements
            toggleFullscreenBtn = document.getElementById('toggleFullscreenBtn');
            fullscreenPreviewModalEl = document.getElementById('fullscreenPreviewModal');
            fullscreenPreviewIframeEl = document.getElementById('fullscreenPreviewIframe');
            closeFullscreenBtn = document.getElementById('closeFullscreenBtn');
            downloadCodeFullscreenBtn = document.getElementById('downloadCodeFullscreenBtn'); // Button inside modal
        }

        // --- Fetch Config (No changes needed here) ---
        async function fetchConfig() {
            if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('YOUR') || APPS_SCRIPT_URL.length < 60) {
                showError("FATAL: Google Apps Script URL is not set correctly in the script. Please deploy your script and paste the URL.", true); disableCoreFunctionality(true); return;
            }
            showStatus("Loading configuration..."); disableCoreFunctionality(true);
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                if (!response.ok) { const errTxt = await response.text().catch(()=>response.statusText); throw new Error(`Config fetch failed (${response.status}): ${errTxt}. Check Apps Script deployment & permissions.`); }
                const config = await response.json();
                if (!config.openRouterKey || !config.githubPat || !config.githubUser || !config.githubRepo) { throw new Error("Config incomplete. Check Sheet A1-A4."); }
                API_KEY=config.openRouterKey; GITHUB_PAT=config.githubPat; GITHUB_USERNAME=config.githubUser; GITHUB_REPO_NAME=config.githubRepo; configLoaded=true;
                if(ghRepoNameEl) ghRepoNameEl.textContent = `${GITHUB_USERNAME}/${GITHUB_REPO_NAME}`;
                selectedModel = modelSelectEl?.value || 'google/gemini-2.0-flash-exp:free';
                console.log("Config loaded."); hideStatus(); disableCoreFunctionality(false); updateButtonStates();
            } catch (error) { console.error("Config Error:", error); showError(`FATAL: Config Error: ${error.message}. Check URL, deployment, & Sheet.`, true); disableCoreFunctionality(true); }
        }

        // --- Utilities (showStatus, hideStatus, showError, hideError - No changes needed) ---
         function showStatus(msg) { if (!statusContainerEl || !statusTextEl) return; statusTextEl.textContent = msg; statusContainerEl.classList.remove('hidden'); hideError(); }
         function hideStatus() { if (statusContainerEl) statusContainerEl.classList.add('hidden'); }
         function showError(msg, isFatal = false) {
             if (!errorDisplayEl) return; console.error("Error:", msg);
             if (msg.includes("Rate limit")) msg = "API Rate Limit Exceeded. Wait or check OpenRouter plan.";
             else if (msg.includes("invalid API key")) msg = "Invalid request Key (Check prompts/internet connection).";
             else if (msg.includes("GitHub Error (404)")) msg = "GitHub Upload Failed (404): Repo/Path not found.";
             else if (msg.includes("GitHub Error (401)")) msg = "GitHub Upload Failed (401): Unauthorized (Check PAT in Sheet A2).";
             else if (msg.includes("GitHub Error (422)")) msg = "GitHub Upload Failed (422): Invalid Path/Encoding.";
             errorDisplayEl.textContent = msg; errorDisplayEl.classList.remove('hidden');
             if (!isFatal) hideStatus();
         }
         function hideError() { if (errorDisplayEl) { errorDisplayEl.classList.add('hidden'); errorDisplayEl.textContent = ''; }}

        // --- Button State Management ---
         function disableCoreFunctionality(disable = true) {
             const elements = [modelSelectEl, generateBtn, fileInputEl];
             elements.forEach(el => { if (el) el.disabled = disable; });
             updateButtonStates();
         }
         function disableProcessingButtons(disable = true) {
             const buttons = [generateBtn, modifyBtn, modifyUploadedBtn, uploadGithubBtn, continueBtn];
             buttons.forEach(b => { if (b) b.disabled = disable; });
             if (disable) {
                 const coreButtons = [showGithubUploadBtn, editBtn, modifyAgainBtn, clearHistoryBtn, toggleFullscreenBtn, refreshBtn, copyBtn, downloadBtn];
                 coreButtons.forEach(b => { if (b) b.disabled = true; });
             } else { updateButtonStates(); }
         }
        // Updated function
        function updateButtonStates() {
             const hasCode = !!currentGeneratedHTML || (isEditingCode && !!editableCodeEl?.value);
             const canUpload = configLoaded && GITHUB_PAT && GITHUB_USERNAME && GITHUB_REPO_NAME;
             const historyAvailable = history.length > 0;

            // Core inputs based on config
             if (modelSelectEl) modelSelectEl.disabled = !configLoaded || isEditingCode; // Disable during edit
             if (generateBtn) generateBtn.disabled = !configLoaded || isEditingCode;
             if (fileInputEl) fileInputEl.disabled = !configLoaded || isEditingCode;
             if (modifyBtn) modifyBtn.disabled = !configLoaded || !currentGeneratedHTML || isEditingCode;
             if (modifyUploadedBtn) modifyUploadedBtn.disabled = !configLoaded || !currentFileContentHTML || isEditingCode;

            // Toolbar buttons based on code presence & edit state
             if (copyBtn) copyBtn.disabled = !hasCode;
             if (downloadBtn) downloadBtn.disabled = !hasCode;
             if (editBtn) editBtn.disabled = !currentGeneratedHTML && !isEditingCode; // Can enable edit only if there's generated code, or already editing
             if (modifyAgainBtn) modifyAgainBtn.disabled = !hasCode || !configLoaded || isEditingCode;
             if (refreshBtn) refreshBtn.disabled = !hasCode;
             if (toggleFullscreenBtn) toggleFullscreenBtn.disabled = !hasCode; // Enable eye icon if code exists

             // GitHub Upload Buttons
             if (showGithubUploadBtn) showGithubUploadBtn.disabled = !hasCode || !canUpload || isEditingCode;
             if (uploadGithubBtn) uploadGithubBtn.disabled = !hasCode || !canUpload || !filePathEl?.value.trim() || isEditingCode; // Also check if path entered

             // Continue button
             if (continueBtn) {
                 const canContinue = hasCode && lastPromptForContinuation && configLoaded && !isEditingCode;
                 continueBtn.classList.toggle('hidden', !canContinue);
                 continueBtn.disabled = !canContinue;
             }

             // History Clear Button
             if (clearHistoryBtn) clearHistoryBtn.disabled = !historyAvailable;

             // Fullscreen download button (enabled if modal open and code exists)
             if (downloadCodeFullscreenBtn) downloadCodeFullscreenBtn.disabled = !hasCode;
         }

        // --- Code Highlighting (Prism Autoloader) ---
        function highlightCode(element) {
            if (!element || typeof Prism === 'undefined' || !element.textContent) return;
            element.className = element.className.replace(/language-\S+/g, '');
            Prism.highlightElement(element);
        }

        // --- Update INLINE Preview ---
        function updateInlinePreview(htmlContent) {
            if (inlineCodePreviewEl) {
                try {
                     const previewContent = htmlContent || '<p style="padding:1em;color:#777;">Preview Area</p>';
                    inlineCodePreviewEl.srcdoc = previewContent;
                } catch (e) {
                    console.error("Inline preview update error:", e);
                    inlineCodePreviewEl.srcdoc = `<p style="padding:1em; color:red;">Preview Error</p>`;
                }
            }
        }

        // --- Utilities (debounce, fileToDataURL, extractHtmlFromMarkdown - No changes needed) ---
        function debounce(fn, wait) { let t; return function(...a){clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait);}}
        function fileToDataURL(file) { return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file);}); }
        function extractHtmlFromMarkdown(rawOutput) {
            if (!rawOutput) return ''; const regex = /```(?:html)?\s*([\s\S]*?)\s*```/;
            const match = rawOutput.match(regex);
            if (match && match[1]) return match[1].trim();
            const trimmedOutput = rawOutput.trim();
            if (trimmedOutput.startsWith('<') && trimmedOutput.endsWith('>')) return trimmedOutput;
            return trimmedOutput; // Return as is if not wrapped/looking like HTML
        }


        // --- Core API Call Logic (OpenRouter - Adjusted) ---
        async function callOpenRouterAPI(messages, isModification = false, isContinuation = false) {
             if (!configLoaded || !API_KEY) { showError("Config not loaded.", true); throw new Error("API Key missing."); }
             if (!selectedModel) { showError("No AI model selected.", true); throw new Error("Model missing."); }
             if (!messages || messages.length === 0) { showError("Internal Error: No messages.", true); throw new Error("No messages provided."); }

             if (currentOperationAbortController) { currentOperationAbortController.abort(); }
             currentOperationAbortController = new AbortController();
             const signal = currentOperationAbortController.signal;

             let rawAccumulatedOutput = '';
             const targetElement = generatedCodeEl;
             if (!targetElement) throw new Error("Code element not found");

             targetElement.textContent = ''; // Clear display
             if (outputSectionEl) outputSectionEl.classList.remove('hidden'); // Show output section
             updateInlinePreview(''); // Clear preview

             if ((isModification || isContinuation) && previousCodeEl && previousCodeContainerEl) {
                 previousCodeEl.textContent = currentGeneratedHTML; highlightCode(previousCodeEl);
                 previousCodeContainerEl.classList.remove('hidden');
             } else if (previousCodeContainerEl) { previousCodeContainerEl.classList.add('hidden'); }

             if (!isModification && !isContinuation) { currentGeneratedHTML = ''; lastRawOutput = ''; }

             showStatus("Sending request to " + selectedModel + "...");
             disableProcessingButtons(true);

             try {
                 console.log(`API Call: Model=${selectedModel}, Mod=${isModification}, Cont=${isContinuation}`);
                 const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                     method: 'POST', headers: { "Authorization": `Bearer ${API_KEY}`, "HTTP-Referer": SITE_URL, "X-Title": SITE_NAME, "Content-Type": "application/json" },
                     body: JSON.stringify({ model: selectedModel, messages: messages, stream: true }), signal: signal
                 });
                 if (!response.ok) { let errData; try { errData = await response.json(); } catch(e){} const msg = errData?.error?.message || `API Error: ${response.status} ${response.statusText}`; throw new Error(msg); }
                 if (!response.body) { throw new Error("API response body missing."); }

                 showStatus("Receiving response stream...");
                 const reader = response.body.getReader(); const decoder = new TextDecoder(); let buffer = ''; let streamFinished = false;
                 while (!streamFinished) {
                     const { done, value } = await reader.read(); if (done) { streamFinished = true; break; }
                     buffer += decoder.decode(value, { stream: true }); let boundary;
                     while ((boundary = buffer.indexOf('\n')) !== -1) {
                         const line = buffer.substring(0, boundary).trim(); buffer = buffer.substring(boundary + 1);
                         if (line.startsWith('data:')) {
                             const jsonStr = line.substring(5).trim(); if (jsonStr === '[DONE]') { streamFinished = true; break; }
                             try { const j = JSON.parse(jsonStr); const d = j.choices?.[0]?.delta?.content; if (d) { rawAccumulatedOutput += d; targetElement.textContent = rawAccumulatedOutput; } }
                             catch (e) { console.warn("Stream parse error:", e, jsonStr); }
                         }
                     } if (streamFinished) break;
                 }
                 if (signal.aborted) { throw new Error("API request aborted."); }

                 showStatus("Stream finished. Processing output...");
                 lastRawOutput = rawAccumulatedOutput;
                 const processedCode = extractHtmlFromMarkdown(rawAccumulatedOutput);
                 targetElement.textContent = processedCode;
                 highlightCode(targetElement);
                 updateInlinePreview(processedCode); // Update inline preview
                 currentGeneratedHTML = processedCode;
                 hideStatus(); console.log("API OK. Code Length:", processedCode.length);
                 return processedCode;

             } catch (error) {
                 console.error("API Call Failed:", error);
                 if (error.name === 'AbortError') { showStatus("Request cancelled."); targetElement.textContent = "// Request cancelled.\n" + targetElement.textContent; }
                 else { showError(`API Error: ${error.message}.`); targetElement.textContent = `// API ERROR: ${error.message}\n// Raw Output:\n${lastRawOutput}`; updateInlinePreview(''); }
                 throw error;
             } finally {
                 disableProcessingButtons(false); updateButtonStates();
                 currentOperationAbortController = null; hideStatus();
             }
        }

        // --- Main Actions (generateCode, continueGeneration, modifyCode - Adjustments) ---
        async function generateCode() {
            hideError(); const prompt = userPromptEl?.value.trim();
            if (!prompt) { showError("Please enter a description."); return; }
            if (!configLoaded) { showError("Config not loaded."); return; }
            lastPromptForContinuation = prompt;
            const messages = [ { role: "system", content: "Genrate a complete html code in one html file single page without mistake and without any explanation only code, use telwind css code and animation effects advanced ui user friendly interface, animation effects, tumko mai jitna futures batayega hu usse jyada add karo aur complete code likho ok ek advance professional school ke liye, icons bhi use karna ok" }, { role: "user", content: prompt } ];
            try {
                if (modifyContainerEl) modifyContainerEl.classList.add('hidden');
                if (uploadLinkContainerEl) uploadLinkContainerEl.classList.add('hidden');
                if (githubUploadContainerEl) githubUploadContainerEl.classList.add('hidden');
                if (previousCodeContainerEl) previousCodeContainerEl.classList.add('hidden');
                if (outputSectionEl) outputSectionEl.classList.add('hidden'); // Hide output until result

                await callOpenRouterAPI(messages, false, false);
                savePrompt(prompt);
                if (modifyContainerEl && currentGeneratedHTML) modifyContainerEl.classList.remove('hidden');
                updateButtonStates();
             } catch (error) { console.error("Generation failed:", error); updateButtonStates(); }
        }
        async function continueGeneration() { /* ... (No changes needed in logic) ... */
             hideError();
             if (!lastPromptForContinuation) { showError("Original prompt not found."); return; }
             if (!currentGeneratedHTML) { showError("No previous code to continue."); return; }
             if (!configLoaded) { showError("Configuration not loaded."); return; }
             if (isEditingCode) { showError("Finish editing first."); return; }
             console.log("Attempting continuation..."); showStatus("Requesting continuation...");
             const messages = [ { role: "system", content: "Append to the provided partial HTML to make it complete based on original prompt. Output ONLY the raw, fully completed HTML code without repeating provided code or markdown." }, { role: "user", content: `Original prompt: "${lastPromptForContinuation}"` }, { role: "user", content: `Partial HTML:\n\`\`\`html\n${currentGeneratedHTML}\n\`\`\`\nContinue this code.` } ];
             try { await callOpenRouterAPI(messages, false, true); alert("Continuation finished. Review result."); updateButtonStates(); }
             catch (error) { console.error("Continuation failed:", error); updateButtonStates(); }
         }
        async function modifyCode() { /* ... (No changes needed in logic) ... */
             hideError(); const mod = modificationPromptEl?.value.trim();
             if (!mod) { showError("Describe modifications."); return; }
             if (!currentGeneratedHTML) { showError("No code to modify."); return; }
             if (!configLoaded) { showError("Configuration not loaded."); return; }
             if (isEditingCode) { showError("Finish editing first."); return; }
             console.log("Applying modifications...");
             const messages = [ { role: "system", content: "Modify the provided HTML. Output only the complete, modified raw HTML, no ```html markdown." }, { role: "user", content: `Current HTML:\n\`\`\`html\n${currentGeneratedHTML}\n\`\`\`` }, { role: "user", content: `Modification: ${mod}` } ];
             try { await callOpenRouterAPI(messages, true, false); if(modificationPromptEl) modificationPromptEl.value = ''; updateButtonStates(); }
             catch (error) { console.error("Modification failed:", error); updateButtonStates(); }
         }

        // --- File Handling & Upload Tab (clearUploadTabState, handleFileSelect, processNonTextFileWithAI, modifyUploadedCode - No changes needed) ---
         function clearUploadTabState() { /* ... No changes ... */ if(fileInputEl)fileInputEl.value='';if(fileContentEl)fileContentEl.textContent='';if(fileContentContainerEl)fileContentContainerEl.classList.add('hidden');if(uploadResponseEl){uploadResponseEl.textContent='';uploadResponseEl.classList.add('hidden');}if(imagePreviewEl){imagePreviewEl.src="";imagePreviewEl.style.display='none';}if(imagePreviewContainerEl)imagePreviewContainerEl.classList.add('hidden');if(fileModifyContainerEl)fileModifyContainerEl.classList.add('hidden');if(fileModificationPromptEl)fileModificationPromptEl.value='';currentFileContentHTML='';hideError();updateButtonStates();}
         async function handleFileSelect() { /* ... No changes ... */ const file = fileInputEl?.files?.[0]; if(!file)return; clearUploadTabState(); showStatus(`Processing: ${file.name}...`); const txtTypes=['text/plain','text/html','text/css','application/javascript','text/markdown'];const knownExts=['.js','.css','.html','.txt','.md','.xml','.json','.yaml'];const maxSize = 10*1024*1024; try { if(file.size>maxSize) throw new Error(`File > 10MB limit.`); if(file.type.startsWith('image/')){if(imagePreviewContainerEl)imagePreviewContainerEl.classList.remove('hidden'); const dUrl=await fileToDataURL(file); if(imagePreviewEl){imagePreviewEl.src=dUrl;imagePreviewEl.style.display='block';}await processNonTextFileWithAI(file,"Describe image content/text.");} else if (txtTypes.includes(file.type)||knownExts.some(e=>file.name.toLowerCase().endsWith(e))){const txt=await file.text();currentFileContentHTML=txt;if(fileContentEl)fileContentEl.textContent=txt;highlightCode(fileContentEl);if(fileContentContainerEl)fileContentContainerEl.classList.remove('hidden');if(fileModifyContainerEl)fileModifyContainerEl.classList.remove('hidden');if(uploadResponseEl){uploadResponseEl.textContent=`Loaded ${file.name}.`;uploadResponseEl.classList.remove('hidden');}} else if (file.type === 'application/pdf') {await processNonTextFileWithAI(file, `Extract text/describe PDF: '${file.name}'.`);} else {await processNonTextFileWithAI(file,`Describe file: '${file.name}' (${file.type}).`);} hideStatus(); } catch (err) { console.error(`File error (${file.name}):`, err); showError(`Error processing "${file.name}": ${err.message}`); hideStatus(); } finally { updateButtonStates(); }}
         async function processNonTextFileWithAI(file, promptTxt) { /* ... No changes ... */ if(!configLoaded){showError("Config needed for AI analysis.");return;} const visionModels=['google/gemini','anthropic/claude'];const usesVision=!visionModels.some(p=>selectedModel.startsWith(p)); if(usesVision){showError(`Selected model ${selectedModel} may not support file analysis. Try Gemini/Claude.`);} showStatus(`AI analyzing ${file.name}...`); if(uploadResponseEl){uploadResponseEl.textContent=`AI analysis...`;uploadResponseEl.classList.remove('hidden');} disableProcessingButtons(true); try { const dUrl=await fileToDataURL(file); const msgs=[{role:"user",content:[{type:"text",text:promptTxt},{type:"image_url",image_url:{url:dUrl}}]}]; const resp = await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{"Authorization":`Bearer ${API_KEY}`,"Content-Type":"application/json","HTTP-Referer":SITE_URL,"X-Title":SITE_NAME},body:JSON.stringify({model:selectedModel,messages:msgs})}); if(!resp.ok){const err=await resp.json().catch(()=>{});throw new Error(err?.error?.message||`AI analysis failed: ${resp.status}`);} const res=await resp.json(); const content=res.choices?.[0]?.message?.content; if(content){currentFileContentHTML=content;if(fileContentEl)fileContentEl.textContent=content;highlightCode(fileContentEl);if(fileContentContainerEl)fileContentContainerEl.classList.remove('hidden');if(fileModifyContainerEl)fileModifyContainerEl.classList.remove('hidden');if(uploadResponseEl)uploadResponseEl.textContent=`AI analysis complete.`} else{throw new Error("AI returned no content.");} } catch(err){console.error("AI Analysis Error:", err);showError(`AI analysis failed: ${err.message}`);if(uploadResponseEl)uploadResponseEl.textContent=`Analysis Error.`;} finally{hideStatus();disableProcessingButtons(false);updateButtonStates();}}
         async function modifyUploadedCode() { /* ... No changes ... */ hideError(); const mod=fileModificationPromptEl?.value.trim();if(!mod){showError("Describe changes.");return;}if(!currentFileContentHTML){showError("No content loaded.");return;}if(!configLoaded){showError("Config not loaded.");return;}console.log("Modifying uploaded content...");const msgs=[{role:"system",content:"Modify content. Output ONLY modified raw result, no markdown."}, {role:"user",content:`Content:\n\`\`\`\n${currentFileContentHTML}\n\`\`\``}, {role:"user",content:`Modification: ${mod}`}]; try{showStatus("Applying changes via AI..."); await callOpenRouterAPI(msgs,true,false);alert("Modification applied. Result in main code output area."); if(fileModificationPromptEl)fileModificationPromptEl.value='';updateButtonStates();} catch(err){console.error("Modify uploaded failed:", err); updateButtonStates();}}

        // --- GitHub Integration (showUploadForm, uploadToGitHub, copyLink - No changes needed) ---
         function showUploadForm() { if(!configLoaded||!GITHUB_PAT){showError("GitHub config missing.");return;}const code=isEditingCode?editableCodeEl?.value:currentGeneratedHTML; if(!code){showError("No code to upload.");return;}if(filePathEl&&!filePathEl.value)filePathEl.value='index.html'; if(commitMessageEl&&!commitMessageEl.value)commitMessageEl.value='feat: Add generated code'; if(githubUploadContainerEl){githubUploadContainerEl.classList.remove('hidden');githubUploadContainerEl.scrollIntoView({behavior:'smooth',block:'nearest'});} updateButtonStates();}
         async function uploadToGitHub() { /* ... No changes ... */ if(!configLoaded||!GITHUB_PAT||!GITHUB_USERNAME||!GITHUB_REPO_NAME){showError("GitHub config missing.", true);return;} const path=filePathEl?.value.trim();const msg=commitMessageEl?.value.trim()||`Update ${path||'file'}`; const content=isEditingCode?editableCodeEl.value:currentGeneratedHTML; if(!path){showError('Specify file path.');return;}if(!content){showError('No content.');return;}const repo=`${GITHUB_USERNAME}/${GITHUB_REPO_NAME}`; const apiUrl=`https://api.github.com/repos/${repo}/contents/${path}`;let encoded;try{encoded=btoa(unescape(encodeURIComponent(content)));}catch(e){showError("Encoding failed.");return;} showStatus(`Uploading ${path}...`);disableProcessingButtons(true);if(uploadLinkContainerEl)uploadLinkContainerEl.classList.add('hidden');try{let sha=null; try{const shaResp=await fetch(apiUrl,{headers:{"Authorization":`token ${GITHUB_PAT}`}}); if(shaResp.ok)sha=(await shaResp.json()).sha; else if(shaResp.status!==404){const err=await shaResp.json().catch(()=>{});throw new Error(`GitHub SHA fetch failed (${shaResp.status}): ${err.message||shaResp.statusText}`);}}catch(e){console.warn("SHA fetch failed (maybe new file):",e.message);} const upResp=await fetch(apiUrl,{method:'PUT',headers:{"Authorization":`token ${GITHUB_PAT}`,"Content-Type":"application/json","Accept":"application/vnd.github.v3+json"},body:JSON.stringify({message:msg,content:encoded,sha:sha})}); if(!upResp.ok){const err=await upResp.json().catch(()=>{});throw new Error(`GitHub Error (${upResp.status}): ${err.message||upResp.statusText}`);} const res=await upResp.json(); console.log("GH Upload OK:",res);let livePath=path.startsWith('/')?path.substring(1):path;if(livePath.toLowerCase()==='index.html')livePath='';const pagesUrl=`https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO_NAME}`; const liveUrl=`${pagesUrl}/${livePath}`; if(uploadedLinkEl){uploadedLinkEl.href=liveUrl;uploadedLinkEl.textContent=liveUrl;}if(uploadLinkContainerEl)uploadLinkContainerEl.classList.remove('hidden'); hideStatus();alert(`Uploaded "${path}" successfully!`);}catch(err){console.error('GitHub Upload Error:',err);showError(`Upload Failed: ${err.message}`);hideStatus();} finally{disableProcessingButtons(false);updateButtonStates();}}
         function copyLink() { /* ... No changes ... */ const link=uploadedLinkEl?.href;if(link&&link!='#'){navigator.clipboard.writeText(link).then(()=>alert('Live link copied!')).catch(e=>{console.error('Copy failed:',e);showError('Copy failed.');});}}


        // --- UI Controls & Interaction (openTab, showModifyForm - Adjusted, clearAll - Adjusted ) ---
        function openTab(tabName, btnEl) { /* ... No changes ... */ document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.add('hidden')); document.querySelectorAll('.tab-button').forEach(tb=>tb.classList.remove('active')); const contentEl=document.getElementById(tabName+'Tab'); if(contentEl)contentEl.classList.remove('hidden'); btnEl?.classList.add('active'); hideError(); if(tabName==='generate'){ if(githubUploadContainerEl)githubUploadContainerEl.classList.add('hidden');if(uploadLinkContainerEl)uploadLinkContainerEl.classList.add('hidden');} }
        const debouncedRefreshPreview = debounce(() => { if (editableCodeEl && isEditingCode) updateInlinePreview(editableCodeEl.value); }, 350);
        function toggleEditCode() { // Adjusted
            if (!generatedCodeEl || !editableCodeEl) return;
            if (!currentGeneratedHTML && !isEditingCode) { // Don't allow entering edit if no code exists
                 showError("No code generated to edit.");
                 return;
             }

            isEditingCode = !isEditingCode;

            if (isEditingCode) { // Enter Edit Mode
                editableCodeEl.value = currentGeneratedHTML; // Use the *processed* code state
                 generatedCodeEl.classList.add('hidden'); editableCodeEl.classList.remove('hidden'); editableCodeEl.focus();
                 editableCodeEl.addEventListener('input', debouncedRefreshPreview);
                 if(editBtn) { editBtn.textContent = 'Save'; editBtn.style.backgroundColor = '#28a745'; editBtn.title = 'Save Changes'; }
                 if(codePaneTitleEl) codePaneTitleEl.textContent = "Editing Code";
                 console.log("Entered editing mode.");
             } else { // Exit Edit Mode (Save)
                 currentGeneratedHTML = editableCodeEl.value; // Save edits
                 generatedCodeEl.textContent = currentGeneratedHTML; highlightCode(generatedCodeEl);
                 editableCodeEl.classList.add('hidden'); generatedCodeEl.classList.remove('hidden');
                 updateInlinePreview(currentGeneratedHTML); // Update preview with saved code
                 editableCodeEl.removeEventListener('input', debouncedRefreshPreview);
                 if(editBtn) { editBtn.textContent = 'Edit'; editBtn.style.backgroundColor = '#ffc107'; editBtn.title = 'Edit code'; }
                 if(codePaneTitleEl) codePaneTitleEl.textContent = "Generated Code";
                 console.log("Exited editing mode, changes saved.");
             }
            updateButtonStates(); // Update all button states
        }
        function showModifyForm() { // Adjusted
             if (!currentGeneratedHTML) { showError("No generated code to modify."); return; }
             if (isEditingCode) { showError("Please save or cancel edits before modifying."); return; }
             if (modifyContainerEl) { modifyContainerEl.classList.remove('hidden'); modifyContainerEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); modificationPromptEl?.focus(); }
         }
        function clearAll() { // Adjusted
             if(userPromptEl)userPromptEl.value=''; if(modificationPromptEl)modificationPromptEl.value=''; if(generatedCodeEl)generatedCodeEl.textContent=''; if(editableCodeEl)editableCodeEl.value='';
             currentGeneratedHTML=''; lastRawOutput=''; lastPromptForContinuation='';
             if(outputSectionEl)outputSectionEl.classList.add('hidden'); // Hide whole output area
             if(modifyContainerEl)modifyContainerEl.classList.add('hidden'); if(previousCodeContainerEl)previousCodeContainerEl.classList.add('hidden'); if(uploadLinkContainerEl)uploadLinkContainerEl.classList.add('hidden'); if(githubUploadContainerEl)githubUploadContainerEl.classList.add('hidden');
             clearUploadTabState(); hideError(); hideStatus(); updateInlinePreview(''); // Clear preview
             // Ensure edit mode is exited cleanly
             if (isEditingCode && generatedCodeEl && editableCodeEl && editBtn && codePaneTitleEl) {
                 isEditingCode = false; generatedCodeEl.classList.remove('hidden'); editableCodeEl.classList.add('hidden');
                 editableCodeEl.removeEventListener('input', debouncedRefreshPreview);
                 editBtn.textContent = 'Edit'; editBtn.style.backgroundColor = '#ffc107'; editBtn.title = 'Edit code';
                 codePaneTitleEl.textContent = "Generated Code";
             }
             updateButtonStates(); console.log("Cleared all.");
         }
        function refreshPreview() { // Adjusted for Inline Preview
            if (!configLoaded) return;
             const code = isEditingCode ? editableCodeEl?.value : currentGeneratedHTML;
             if (hasCode) {
                 showStatus("Refreshing preview..."); updateInlinePreview(code); setTimeout(hideStatus, 500);
             } else { updateInlinePreview(''); } // Clear preview if no code
         }

        // --- History (savePrompt, updateHistoryDisplay, loadPromptFromHistory, clearHistory, saveHistoryToLocalStorage, loadHistoryFromLocalStorage - No changes needed) ---
         function savePrompt(prompt){if(!prompt)return;if(history.length===0||history[history.length-1]!==prompt){history.push(prompt);if(history.length>MAX_HISTORY){history.shift();}updateHistoryDisplay();saveHistoryToLocalStorage();}}
         function updateHistoryDisplay(){if(!historyItemsEl)return; historyItemsEl.innerHTML=''; if(history.length===0){historyItemsEl.innerHTML='<p style="color:#777;font-size:14px;">No history.</p>';}else{[...history].reverse().forEach(item=>{const d=document.createElement('div');d.className='history-item';d.textContent=item;d.title=`Use: "${item}"`;d.onclick=()=>loadPromptFromHistory(item);d.setAttribute('role','button');d.setAttribute('tabindex','0');d.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' ')loadPromptFromHistory(item);});historyItemsEl.appendChild(d);});} updateButtonStates();}
         function loadPromptFromHistory(prompt){if(userPromptEl){userPromptEl.value=prompt; const btn=document.getElementById('generateTabButton');if(btn&&!btn.classList.contains('active')){openTab('generate',btn);} userPromptEl.focus();console.log("Loaded history prompt.");}}
         function clearHistory(){if(confirm("Clear prompt history?")){history=[];updateHistoryDisplay();saveHistoryToLocalStorage();console.log("History cleared.");}}
         function saveHistoryToLocalStorage(){try{localStorage.setItem('aiBuilderPromptHistoryV3', JSON.stringify(history));}catch(e){console.warn("Failed to save history:",e);}}
         function loadHistoryFromLocalStorage(){try{const s=localStorage.getItem('aiBuilderPromptHistoryV3');if(s){history=JSON.parse(s);if(!Array.isArray(history))history=[];}else{history=[];}}catch(e){console.warn("Failed to load history:",e);history=[];} updateHistoryDisplay();}


        // --- Theme Management (toggleMode, loadModePreference - No changes needed) ---
         function toggleMode(){document.body.classList.toggle('dark-mode');const m=document.body.classList.contains('dark-mode')?'dark':'light';localStorage.setItem('themeModeV3',m);console.log(`Theme: ${m}`); if(fullscreenPreviewModalEl) fullscreenPreviewModalEl.classList.toggle('dark-modal', m === 'dark'); /* Optional dark modal bg */ }
         function loadModePreference(){const m=localStorage.getItem('themeModeV3');if(m==='dark'){document.body.classList.add('dark-mode'); if(fullscreenPreviewModalEl) fullscreenPreviewModalEl.classList.add('dark-modal'); }else{document.body.classList.remove('dark-mode'); if(fullscreenPreviewModalEl) fullscreenPreviewModalEl.classList.remove('dark-modal');}}

        // --- Model Selection (handleModelChange - No changes needed) ---
        function handleModelChange() { if (modelSelectEl) { selectedModel = modelSelectEl.value; console.log("Model:", selectedModel); } }

        // --- Fullscreen Preview Logic ---
        function toggleFullScreenPreview() {
            if (!fullscreenPreviewModalEl || !fullscreenPreviewIframeEl) return;

            const code = isEditingCode ? editableCodeEl?.value : currentGeneratedHTML;
            if (!code) {
                showError("No code to preview in fullscreen.");
                return;
            }

             // Check if already open to close it, otherwise open it
            if (fullscreenPreviewModalEl.style.display === 'block') {
                 closeFullScreenPreview();
            } else {
                 openFullScreenPreview(code);
             }
        }

        function openFullScreenPreview(htmlContent) {
             if (!fullscreenPreviewModalEl || !fullscreenPreviewIframeEl) return;
            console.log("Opening fullscreen preview...");
            fullscreenPreviewIframeEl.srcdoc = htmlContent; // Set content
             fullscreenPreviewModalEl.style.display = 'block'; // Show modal
             document.body.classList.add('modal-open'); // Disable body scroll
            document.addEventListener('keydown', handleEscKey); // Add escape key listener
            updateButtonStates(); // Update modal button states if needed
        }

        function closeFullScreenPreview() {
             if (!fullscreenPreviewModalEl) return;
             console.log("Closing fullscreen preview...");
            fullscreenPreviewModalEl.style.display = 'none'; // Hide modal
             fullscreenPreviewIframeEl.srcdoc = ''; // Clear iframe content
             document.body.classList.remove('modal-open'); // Enable body scroll
            document.removeEventListener('keydown', handleEscKey); // Remove escape key listener
        }

        // Handle Escape key press to close the modal
        function handleEscKey(event) {
            if (event.key === 'Escape') {
                closeFullScreenPreview();
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Ready.");
            cacheDOMElements();
            loadModePreference();
            loadHistoryFromLocalStorage();
            updateButtonStates(); // Initial states (mostly disabled)
            updateInlinePreview(''); // Initialize inline preview
            fetchConfig(); // Load API keys etc.

            // Feedback for copy button
            if (copyBtn) { copyBtn.addEventListener('click', () => { if(!copyBtn.disabled){const t=copyBtn.textContent;copyBtn.textContent='Copied!';setTimeout(()=>{copyBtn.textContent=t;},1500);}}); }
        });

        // --- Copy Code (No changes needed) ---
        function copyCode() { /* ... No changes ... */ const code = isEditingCode?editableCodeEl?.value:currentGeneratedHTML; if(!code){showError("No code to copy.");return;} navigator.clipboard.writeText(code).then(()=>{console.log("Code copied.");}).catch(err=>{console.error("Copy failed:", err);showError("Copy failed.");}); }

        // --- Download Code (No changes needed - this IS the filtered code) ---
        function downloadCode() {
            const code = isEditingCode ? editableCodeEl?.value : currentGeneratedHTML; // Gets the correct code (generated/edited)
             if (!code) { showError("No code to download."); return; }
             try {
                 const blob = new Blob([code], { type: 'text/html;charset=utf-8' }); // Ensure UTF-8
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url; a.download = 'ai-website.html'; // Filename
                 document.body.appendChild(a); a.click(); document.body.removeChild(a);
                 URL.revokeObjectURL(url); console.log("Download initiated.");
             } catch (err) { console.error("Download failed:", err); showError("Download failed."); }
        }

        // ====== END: Improved JavaScript ======
    </script>

</body>
</html>